================================================================================
TASK 3: FEATURE SERVICE REFACTORING - TIER 2 - TO-DO LIST
================================================================================

Task: 3 - Feature Service Refactoring (Tier 2 - Moderate Complexity Services)
Start Date: December 5, 2025
Estimated Duration: 18 hours
Status: ğŸŸ¡ PENDING START

================================================================================
TASK OVERVIEW
================================================================================

Objective:
  Refactor 18 moderate-complexity services from PostgreSQL to MongoDB/Mongoose.
  These services use relationships, populate(), and some aggregations.

Services to Refactor (in priority order):
  1. sadhanaService.js (18.4KB) - Core spiritual practice feature
  2. bookService.js (16.9KB) - Book library management
  3. socialService.js (18.2KB) - Social features and graph
  4. sadhanaProgressionService.js (12.3KB) - Progress tracking
  5. userProgressionService.js (12.4KB) - User progression stats
  6. communityService.js (6.8KB) - Community management
  7. bookAnalyticsService.js (9.8KB) - Book analytics
  8. dashboardService.js (6.9KB) - Dashboard data aggregation
  9. dashboardStatsService.js (4.7KB) - Statistics aggregation
  10. alertService.js (7.3KB) - Alert management
  11. reminderService.js (4.7KB) - Reminder scheduling
  12. contentApprovalService.js (6.4KB) - Content moderation
  13. achievementService.js (5.1KB) - Achievement tracking
  14. systemAlertService.js (4.1KB) - System notifications
  15. mentorshipService.js (2.1KB) - Mentorship relationships
  16. mediaProcessingService.js (5.0KB) - Media operations
  17. eventService.js (4.2KB) - Event handling
  18. redisService.js (1.2KB) - Caching layer

Characteristics:
  âœ“ Uses relationships with populate()
  âœ“ Some aggregation pipelines
  âœ“ Filtering and complex queries
  âœ“ Statistics calculations
  âœ“ Pagination with relationships

Key Differences from Tier 1:
  â€¢ Will use populate() for relationship loading
  â€¢ Some services need aggregation pipelines
  â€¢ More complex filtering logic
  â€¢ Statistics/counting operations
  â€¢ Potential for performance optimization

Dependencies:
  âœ“ All 34 MongoDB schemas created (Phase 2 complete)
  âœ“ Tier 1 services completed (Task 2 complete)
  âœ“ All Mongoose patterns validated

Blockers: NONE

================================================================================
TIER 2 REFACTORING PATTERNS
================================================================================

Pattern 1: Find with Populate (Simple Join)
  OLD:  db.query('SELECT s.*, u.name FROM sadhanas s 
        JOIN users u ON s.user_id = u.id WHERE s.id = $1', [id])
  NEW:  const sadhana = await Sadhana.findById(id).populate('userId', 'displayName');

Pattern 2: Find with Multiple Relationships
  OLD:  Complex multi-table join with WHERE
  NEW:  Sadhana.findById(id)
        .populate('userId')
        .populate('likeIds')
        .populate('commentIds');

Pattern 3: List with Pagination and Populate
  OLD:  SELECT * FROM items WHERE condition LIMIT x OFFSET y
  NEW:  Item.find(query)
        .populate('userId')
        .sort({createdAt: -1})
        .limit(10)
        .skip(offset);

Pattern 4: Aggregation Pipeline (GROUP BY)
  OLD:  SELECT COUNT(*) as count, AVG(duration) as avg 
        FROM sadhana_progress GROUP BY user_id
  NEW:  SadhanaProgress.aggregate([
        {$match: {userId: ObjectId(userId)}},
        {$group: {_id: '$userId', count: {$sum: 1}, avg: {$avg: '$duration'}}}
        ]);

Pattern 5: Counting with Relationship
  OLD:  SELECT COUNT(*) FROM likes WHERE sadhana_id = $1
  NEW:  Like.countDocuments({sadhanaId});

Pattern 6: Complex Filtering with Relationships
  OLD:  Complex WHERE with multiple AND/OR conditions
  NEW:  find({$and: [{status: 'active'}, {$or: [{userId}, {sharedWith}]}]})

Pattern 7: Sorting with Statistics
  OLD:  SELECT *, COUNT(likes) as likeCount FROM sadhanas 
        GROUP BY id ORDER BY likeCount DESC
  NEW:  Aggregation with $sort on computed field

Pattern 8: Date Range Queries
  OLD:  WHERE created_at >= $1 AND created_at <= $2
  NEW:  find({createdAt: {$gte: start, $lte: end}})

================================================================================
DETAILED SUBTASKS
================================================================================

## SUBTASK 1: Refactor sadhanaService.js (Core Feature - 2 hours)
Status: â³ PENDING
Importance: CRITICAL

Description:
  Core sadhana (spiritual practice) service with user relationships

Services:
  â–¡ 1.1: getUserSadhanas() - Find with userId reference
  â–¡ 1.2: createSadhana() - Create with relationships
  â–¡ 1.3: updateSadhana() - Update with validation
  â–¡ 1.4: deleteSadhana() - Soft delete
  â–¡ 1.5: getSadhanaProgress() - Related data fetch
  â–¡ 1.6: upsertSadhanaProgress() - Create/update progress

Key Patterns:
  â€¢ User relationship via populate()
  â€¢ Progress tracking with aggregation
  â€¢ Status filtering (active, completed, paused)

Acceptance Criteria:
  âœ“ All db.query() converted
  âœ“ User relationships work via populate()
  âœ“ Progress tracking functional
  âœ“ Status transitions work correctly

---

## SUBTASK 2: Refactor bookService.js (2 hours)
Status: â³ PENDING
Importance: CRITICAL

Description:
  Book library management with user and engagement relationships

Services:
  â–¡ 2.1: getUserBooks() - Find with user relationship
  â–¡ 2.2: createBook() - Create new book
  â–¡ 2.3: updateBook() - Update metadata
  â–¡ 2.4: deleteBook() - Soft delete
  â–¡ 2.5: getPublicBooks() - Find public books
  â–¡ 2.6: searchBooks() - Text search functionality

Key Patterns:
  â€¢ User relationship via populate()
  â€¢ Text search with $text operator
  â€¢ Privacy filtering (isPublic)
  â€¢ Rating aggregation

Acceptance Criteria:
  âœ“ All queries converted
  âœ“ Text search working
  âœ“ Privacy filtering in place
  âœ“ Relationships functioning

---

## SUBTASK 3: Refactor socialService.js (2 hours)
Status: â³ PENDING
Importance: CRITICAL

Description:
  Social graph operations: shares, comments, likes, follows

Services:
  â–¡ 3.1: getSocialFeed() - Complex multi-collection query
  â–¡ 3.2: likeItem() - Create/update like
  â–¡ 3.3: commentOnItem() - Create comment with threading
  â–¡ 3.4: shareItem() - Create share record
  â–¡ 3.5: followUser() - Create follow relationship
  â–¡ 3.6: getFriendsList() - List user's social connections

Key Patterns:
  â€¢ Complex aggregation for feed
  â€¢ Multiple relationship types
  â€¢ Threading for comments
  â€¢ Social graph traversal

Acceptance Criteria:
  âœ“ Social feed aggregation working
  âœ“ All operations creating proper relationships
  âœ“ Threading working correctly
  âœ“ Privacy levels respected

---

## SUBTASK 4: Refactor sadhanaProgressionService.js (1.5 hours)
Status: â³ PENDING

Description:
  Sadhana progress tracking with statistics

Services:
  â–¡ 4.1: logProgress() - Create progress entry
  â–¡ 4.2: getProgressHistory() - Find with date range
  â–¡ 4.3: calculateStats() - Aggregation pipeline
  â–¡ 4.4: getStreak() - Calculate consecutive days

Key Patterns:
  â€¢ Date range filtering
  â€¢ Aggregation for statistics
  â€¢ Streak calculation logic

---

## SUBTASK 5: Refactor userProgressionService.js (1.5 hours)
Status: â³ PENDING

Description:
  User progression (levels, experience points, achievements)

---

## SUBTASK 6: Refactor communityService.js (1.5 hours)
Status: â³ PENDING

Description:
  Community/group management with member relationships

---

## SUBTASK 7: Refactor bookAnalyticsService.js (1 hour)
Status: â³ PENDING

Description:
  Book analytics: stats, trends, recommendations

Key Patterns:
  â€¢ Aggregation pipelines for analytics
  â€¢ Time-series grouping
  â€¢ Trending calculations

---

## SUBTASK 8: Refactor dashboardService.js (1 hour)
Status: â³ PENDING

Description:
  Dashboard data aggregation from multiple sources

---

## SUBTASK 9: Refactor dashboardStatsService.js (1 hour)
Status: â³ PENDING

Description:
  Statistics aggregation (user stats, system stats)

---

## SUBTASK 10: Refactor alertService.js (1 hour)
Status: â³ PENDING

Description:
  Alert management and notifications

---

## SUBTASK 11: Refactor reminderService.js (1 hour)
Status: â³ PENDING

Description:
  Reminder scheduling and delivery

---

## SUBTASK 12: Refactor contentApprovalService.js (1 hour)
Status: â³ PENDING

Description:
  Content moderation and approval workflow

---

## SUBTASK 13: Refactor achievementService.js (1 hour)
Status: â³ PENDING

Description:
  Achievement unlocking and tracking

---

## SUBTASK 14: Refactor systemAlertService.js (1 hour)
Status: â³ PENDING

Description:
  System alert generation and tracking

---

## SUBTASK 15: Refactor mentorshipService.js (0.75 hours)
Status: â³ PENDING

Description:
  Mentorship relationships and goal tracking

---

## SUBTASK 16: Refactor mediaProcessingService.js (0.75 hours)
Status: â³ PENDING

Description:
  Media file processing and storage

---

## SUBTASK 17: Refactor eventService.js (0.75 hours)
Status: â³ PENDING

Description:
  Event handling and publishing

---

## SUBTASK 18: Refactor redisService.js (0.5 hours)
Status: â³ PENDING

Description:
  Redis caching layer integration

---

## SUBTASK 19: Comprehensive Tier 2 Testing (2 hours)
Status: â³ PENDING

Description:
  Test all Tier 2 services with relationships and aggregations

---

## SUBTASK 20: Create Tier 2 Progress Report (1 hour)
Status: â³ PENDING

Description:
  Document Task 3 completion and metrics

================================================================================
EXECUTION STRATEGY
================================================================================

Phase 1 (Critical Services, 6 hours):
  1. sadhanaService.js (2 hours)
  2. bookService.js (2 hours)
  3. socialService.js (2 hours)
  
  After Phase 1: Unblock most feature modules

Phase 2 (Feature Services, 7 hours):
  4-6. Progression services (4.5 hours)
  7-11. Analytics & alerts (3.5 hours)

Phase 3 (Supporting Services, 3 hours):
  12-18. Moderation, achievement, media, events, caching (3 hours)

Phase 4 (Testing & Documentation, 2 hours):
  19-20. Comprehensive testing and progress report

Total: 18 hours

================================================================================
SUCCESS CRITERIA
================================================================================

Tier 2 Complete when:

  âœ… All 18 services refactored
  âœ… All db.query() calls removed
  âœ… All populate() relationships working
  âœ… Aggregation pipelines implemented
  âœ… Date range queries functional
  âœ… Text search working
  âœ… All tests passing
  âœ… Ready for Tier 3

================================================================================
READY FOR TIER 2 REFACTORING
================================================================================

Status: âœ… READY

Prerequisites:
  âœ“ Tier 1 services complete
  âœ“ All 34 schemas created
  âœ“ Refactoring patterns verified
  âœ“ Relationship mappings understood

Confidence Level: HIGH âœ…

Waiting for confirmation to begin Task 3: Tier 2 Service Refactoring.

================================================================================

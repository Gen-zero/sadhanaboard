================================================================================
PHASE 3: SERVICE REFACTORING - COMPREHENSIVE TO-DO LIST
================================================================================

Phase: 3 - Service Refactoring
Start Date: December 5, 2025
Estimated Duration: 70-80 hours (2 weeks of focused work)
Status: ðŸŸ¡ PENDING START

================================================================================
PHASE OVERVIEW
================================================================================

Objective:
  Refactor 46 existing backend services to use MongoDB/Mongoose instead of
  Supabase PostgreSQL. Convert db.query() syntax to Mongoose methods and
  update all data relationships.

Current State:
  âœ… Phase 2: All 34 schemas created (12,694 lines)
  â³ Phase 3: 0 services refactored

Services to Refactor: 46
  - Authentication services (5)
  - User services (4)
  - Sadhana services (6)
  - Book services (4)
  - Social/Community services (5)
  - Admin services (4)
  - Notification services (3)
  - Support services (3)
  - Analytics services (2)
  - Other services (5)

Key Challenges:
  â€¢ Converting SQL queries to MongoDB aggregation pipelines
  â€¢ Updating join operations to Mongoose populate()
  â€¢ Handling transactions (if needed)
  â€¢ Maintaining backward compatibility with existing routes
  â€¢ Testing all modified services

Dependencies:
  âœ“ All 34 schemas created (Phase 2 complete)
  âœ“ MongoDB Atlas connected (Phase 1 complete)
  âœ“ config/mongodb.js initialized (Phase 1 complete)

================================================================================
PHASE 3 STRUCTURE - HIGH LEVEL TASKS
================================================================================

Phase 3 consists of 5 main work tasks:

  TASK 1: Service Discovery & Analysis (8 hours)
  â”œâ”€ Identify all 46 services
  â”œâ”€ Analyze current db.query() patterns
  â”œâ”€ Map SQL queries to Mongoose equivalents
  â”œâ”€ Create migration guide for each service type
  â””â”€ Document complex queries requiring aggregation

  TASK 2: Core Service Refactoring - Tier 1 (18 hours)
  â”œâ”€ Authentication services (auth.service.js)
  â”œâ”€ User services (user.service.js)
  â”œâ”€ Basic CRUD operations
  â”œâ”€ Simple find/update/delete operations
  â””â”€ Test each service tier

  TASK 3: Feature Service Refactoring - Tier 2 (18 hours)
  â”œâ”€ Sadhana services
  â”œâ”€ Book services
  â”œâ”€ Relationship queries (populate)
  â”œâ”€ Complex filters
  â””â”€ Test all Tier 2 services

  TASK 4: Advanced Service Refactoring - Tier 3 (18 hours)
  â”œâ”€ Social/Community services
  â”œâ”€ Admin services
  â”œâ”€ Aggregation pipelines
  â”œâ”€ Analytics queries
  â”œâ”€ Multi-step operations
  â””â”€ Test all Tier 3 services

  TASK 5: Integration & Verification (8 hours)
  â”œâ”€ Route integration testing
  â”œâ”€ End-to-end testing
  â”œâ”€ Performance validation
  â”œâ”€ Error handling verification
  â””â”€ Documentation updates

Total: ~70 hours

================================================================================
DETAILED TASK BREAKDOWN
================================================================================

## TASK 1: SERVICE DISCOVERY & ANALYSIS (8 hours)
Status: â³ PENDING

Subtask 1.1: Identify All Services (1 hour)
  â–¡ List all 46 services
  â–¡ Categorize by type
  â–¡ Count methods per service
  â–¡ Estimate complexity (Low/Medium/High)
  â–¡ Create service inventory spreadsheet

Subtask 1.2: Analyze Current Patterns (2 hours)
  â–¡ Sample 10 services
  â–¡ Document current db.query() patterns
  â–¡ Identify common SQL patterns:
    - Simple SELECT
    - JOIN operations
    - GROUP BY aggregations
    - Filtering/WHERE
    - Sorting/ORDER BY
    - Pagination/LIMIT
  â–¡ Create pattern documentation

Subtask 1.3: Map to Mongoose Equivalents (2 hours)
  â–¡ SQL SELECT â†’ find() / findOne()
  â–¡ JOIN â†’ populate()
  â–¡ WHERE â†’ $match in aggregation
  â–¡ GROUP BY â†’ $group in aggregation
  â–¡ ORDER BY â†’ sort()
  â–¡ LIMIT â†’ limit()
  â–¡ COUNT â†’ countDocuments()
  â–¡ Create mapping reference guide

Subtask 1.4: Complex Query Analysis (2 hours)
  â–¡ Identify services with complex queries
  â–¡ Services requiring aggregation pipelines
  â–¡ Services with transactions (if any)
  â–¡ Services with raw SQL (if any)
  â–¡ Create list of special cases
  â–¡ Plan aggregation approach for each

Subtask 1.5: Document Migration Guide (1 hour)
  â–¡ Create migration template for each service type
  â–¡ Write examples for common patterns
  â–¡ Document error handling approach
  â–¡ Create testing checklist

Acceptance Criteria:
  âœ“ All 46 services identified and inventoried
  âœ“ All patterns documented
  âœ“ Mongoose equivalents mapped
  âœ“ Complex queries identified
  âœ“ Migration guide ready

---

## TASK 2: CORE SERVICE REFACTORING - TIER 1 (18 hours)
Status: â³ PENDING

Tier 1 includes basic services with simple queries:
  â€¢ Authentication service
  â€¢ User service
  â€¢ Profile service
  â€¢ Session service
  â€¢ Basic CRUD services

Subtask 2.1: Auth Service Refactoring (3 hours)
  â–¡ Refactor: findByEmail()
  â–¡ Refactor: findByPasswordResetToken()
  â–¡ Refactor: findActive()
  â–¡ Add Mongoose methods
  â–¡ Test all auth queries
  â–¡ Verify password hashing compatibility

Subtask 2.2: User Service Refactoring (3 hours)
  â–¡ Refactor: findById()
  â–¡ Refactor: findAll()
  â–¡ Refactor: create()
  â–¡ Refactor: update()
  â–¡ Refactor: delete()
  â–¡ Test CRUD operations

Subtask 2.3: Profile Service Refactoring (3 hours)
  â–¡ Refactor: findByUserId()
  â–¡ Refactor: findByLocation()
  â–¡ Refactor: findByTradition()
  â–¡ Add populate for userId reference
  â–¡ Test with populated data

Subtask 2.4: Session Service Refactoring (3 hours)
  â–¡ Refactor: findByToken()
  â–¡ Refactor: findByAdminId()
  â–¡ Refactor: findExpired()
  â–¡ Add TTL index operations
  â–¡ Test expiration logic

Subtask 2.5: Basic CRUD Services (3 hours)
  â–¡ Identify other simple CRUD services
  â–¡ Refactor each service
  â–¡ Verify basic operations work
  â–¡ Test each service

Subtask 2.6: Tier 1 Testing (3 hours)
  â–¡ Create test file for Tier 1 services
  â–¡ Test each find operation
  â–¡ Test each create operation
  â–¡ Test each update operation
  â–¡ Test each delete operation
  â–¡ Verify error handling

Acceptance Criteria:
  âœ“ All Tier 1 services refactored
  âœ“ All basic queries working
  âœ“ All tests passing
  âœ“ Error handling verified
  âœ“ Ready for Tier 2

---

## TASK 3: FEATURE SERVICE REFACTORING - TIER 2 (18 hours)
Status: â³ PENDING

Tier 2 includes services with relationships and moderate complexity:
  â€¢ Sadhana service (6 methods)
  â€¢ Book service (4 methods)
  â€¢ Community services
  â€¢ Engagement services

Subtask 3.1: Sadhana Service Refactoring (4 hours)
  â–¡ Refactor: findActiveByUser()
  â–¡ Refactor: findPublic()
  â–¡ Refactor: findTrending()
  â–¡ Add text search for title/description
  â–¡ Test with populate (userId â†’ User)
  â–¡ Test aggregations

Subtask 3.2: Sadhana Progress Service (3 hours)
  â–¡ Refactor: findByDateRange()
  â–¡ Refactor: findToday()
  â–¡ Refactor: getCompletionRate()
  â–¡ Refactor: getTotalMinutes()
  â–¡ Test aggregations for stats

Subtask 3.3: Book Service Refactoring (4 hours)
  â–¡ Refactor: findByUser()
  â–¡ Refactor: findPublic()
  â–¡ Refactor: findTrending()
  â–¡ Refactor: search()
  â–¡ Add full-text search
  â–¡ Test with relationships

Subtask 3.4: Book Progress Service (3 hours)
  â–¡ Refactor: findActiveByUser()
  â–¡ Refactor: getCompletionRate()
  â–¡ Refactor: getAverageReadingTime()
  â–¡ Test with populate and aggregation

Subtask 3.5: Engagement Services (2 hours)
  â–¡ Refactor: Like/Comment services
  â–¡ Refactor: View tracking
  â–¡ Test engagement operations

Subtask 3.6: Tier 2 Testing (2 hours)
  â–¡ Create test file for Tier 2 services
  â–¡ Test populate operations
  â–¡ Test aggregation pipelines
  â–¡ Test text search
  â–¡ Verify complex queries

Acceptance Criteria:
  âœ“ All Tier 2 services refactored
  âœ“ All relationships working (populate)
  âœ“ All aggregations working
  âœ“ All tests passing
  âœ“ Ready for Tier 3

---

## TASK 4: ADVANCED SERVICE REFACTORING - TIER 3 (18 hours)
Status: â³ PENDING

Tier 3 includes complex services with aggregations and multi-step operations:
  â€¢ Social/Community services
  â€¢ Admin services
  â€¢ Analytics services
  â€¢ Notification services

Subtask 4.1: Group Service Refactoring (3 hours)
  â–¡ Refactor: findByCreator()
  â–¡ Refactor: findPublic()
  â–¡ Refactor: findTrending()
  â–¡ Refactor: search()
  â–¡ Add member count aggregation
  â–¡ Test complex queries

Subtask 4.2: GroupMember Service (2 hours)
  â–¡ Refactor: findByGroup()
  â–¡ Refactor: findModerators()
  â–¡ Refactor: hasPermission()
  â–¡ Test role-based queries

Subtask 4.3: Mentorship Services (3 hours)
  â–¡ Refactor: findByMentor()
  â–¡ Refactor: findByMentee()
  â–¡ Refactor: findActiveMentees()
  â–¡ Test relationship queries

Subtask 4.4: Admin Services (3 hours)
  â–¡ Refactor: AuditLog queries
  â–¡ Refactor: SystemMetrics queries
  â–¡ Refactor: FeatureFlag queries
  â–¡ Test admin operations

Subtask 4.5: Analytics Services (3 hours)
  â–¡ Refactor: BiReport generation
  â–¡ Refactor: aggregation pipelines
  â–¡ Refactor: date range queries
  â–¡ Test analytics computations

Subtask 4.6: Notification Services (2 hours)
  â–¡ Refactor: NotificationLog queries
  â–¡ Refactor: UserNotification queries
  â–¡ Test notification operations

Subtask 4.7: Tier 3 Testing (2 hours)
  â–¡ Create test file for Tier 3 services
  â–¡ Test aggregations
  â–¡ Test complex joins
  â–¡ Test analytics calculations
  â–¡ Verify all operations

Acceptance Criteria:
  âœ“ All Tier 3 services refactored
  âœ“ All complex queries working
  âœ“ All aggregations verified
  âœ“ All tests passing
  âœ“ Ready for integration

---

## TASK 5: INTEGRATION & VERIFICATION (8 hours)
Status: â³ PENDING

Subtask 5.1: Route Integration Testing (2 hours)
  â–¡ Test all routes using refactored services
  â–¡ Verify data flow end-to-end
  â–¡ Check response formats
  â–¡ Verify error handling in routes

Subtask 5.2: Data Consistency Verification (2 hours)
  â–¡ Verify data relationships intact
  â–¡ Check foreign key references
  â–¡ Verify population works correctly
  â–¡ Test cascading operations (if applicable)

Subtask 5.3: Performance Validation (2 hours)
  â–¡ Monitor query performance
  â–¡ Check index usage
  â–¡ Identify slow queries
  â–¡ Optimize if needed

Subtask 5.4: Final Testing & Documentation (2 hours)
  â–¡ Create Phase 3 completion report
  â–¡ Document any issues found
  â–¡ Create runbook for service operation
  â–¡ Prepare for Phase 4

Acceptance Criteria:
  âœ“ All services integrated
  âœ“ All tests passing
  âœ“ All routes working
  âœ“ Performance acceptable
  âœ“ Documentation complete

================================================================================
EXECUTION STRATEGY
================================================================================

Sequential Order:

1ï¸âƒ£ Task 1: Service Discovery & Analysis (8 hours) - Days 1-2
2ï¸âƒ£ Task 2: Core Service Refactoring (18 hours) - Days 3-5
3ï¸âƒ£ Task 3: Feature Service Refactoring (18 hours) - Days 6-8
4ï¸âƒ£ Task 4: Advanced Service Refactoring (18 hours) - Days 9-11
5ï¸âƒ£ Task 5: Integration & Verification (8 hours) - Days 12-13

Total: ~70 hours = 2 weeks

Per-Day Breakdown:
  Hours per day: 5-6 hours
  Days per week: 5 (Monday-Friday)
  Weeks: 2-3

================================================================================
REFACTORING PATTERNS
================================================================================

Pattern 1: Simple Find
  OLD:  const user = await db.query('SELECT * FROM users WHERE id = ?', [id]);
  NEW:  const user = await User.findById(id);

Pattern 2: Find with Condition
  OLD:  const user = await db.query('SELECT * FROM users WHERE email = ?', [email]);
  NEW:  const user = await User.findOne({ email });

Pattern 3: Find All
  OLD:  const users = await db.query('SELECT * FROM users ORDER BY createdAt DESC');
  NEW:  const users = await User.find().sort({ createdAt: -1 });

Pattern 4: Find with Join
  OLD:  const sadhana = await db.query('SELECT s.*, u.displayName FROM sadhanas s 
        JOIN users u ON s.userId = u._id WHERE s.id = ?', [id]);
  NEW:  const sadhana = await Sadhana.findById(id).populate('userId', 'displayName');

Pattern 5: Count
  OLD:  const count = await db.query('SELECT COUNT(*) FROM users');
  NEW:  const count = await User.countDocuments();

Pattern 6: Create
  OLD:  await db.query('INSERT INTO users (email, password) VALUES (?, ?)', [email, password]);
  NEW:  const user = new User({ email, password });
        await user.save();

Pattern 7: Update
  OLD:  await db.query('UPDATE users SET displayName = ? WHERE id = ?', [name, id]);
  NEW:  await User.findByIdAndUpdate(id, { displayName: name });

Pattern 8: Delete
  OLD:  await db.query('DELETE FROM users WHERE id = ?', [id]);
  NEW:  await User.findByIdAndDelete(id);

Pattern 9: Aggregation/Count
  OLD:  const stats = await db.query(
        'SELECT COUNT(*) as count, AVG(duration) as avgDuration FROM sadhana_progress 
        WHERE userId = ? AND date >= ?', [userId, startDate]);
  NEW:  const stats = await SadhanaProgress.aggregate([
        { $match: { userId, progressDate: { $gte: startDate } } },
        { $group: { _id: null, count: { $sum: 1 }, avgDuration: { $avg: '$duration' } } }
        ]);

Pattern 10: Text Search
  OLD:  const results = await db.query('SELECT * FROM sadhanas WHERE title ILIKE ? 
        OR description ILIKE ?', [`%${query}%`, `%${query}%`]);
  NEW:  const results = await Sadhana.find({ $text: { $search: query } });

================================================================================
TESTING STRATEGY
================================================================================

Unit Testing:
  â€¢ Test each refactored service method
  â€¢ Mock database calls
  â€¢ Verify correct queries generated
  â€¢ Check error handling

Integration Testing:
  â€¢ Test services with real MongoDB connection
  â€¢ Test data population
  â€¢ Test aggregations
  â€¢ Verify data relationships

End-to-End Testing:
  â€¢ Test full request/response cycle
  â€¢ Test all routes
  â€¢ Test error scenarios
  â€¢ Performance testing

================================================================================
COMMON CHALLENGES & SOLUTIONS
================================================================================

Challenge 1: Complex SQL Joins
  Solution: Use Mongoose populate() for simple joins, aggregation pipelines for complex

Challenge 2: GROUP BY with aggregations
  Solution: Use MongoDB $group stage in aggregation pipeline

Challenge 3: Transactions
  Solution: Use MongoDB sessions if multi-document transactions needed

Challenge 4: Raw SQL functions
  Solution: Implement equivalent logic in JavaScript or use MongoDB functions

Challenge 5: Pagination
  Solution: Use skip() and limit() with sort()

================================================================================
SUCCESS CRITERIA
================================================================================

Phase 3 is complete when:

  âœ… All 46 services refactored to use MongoDB
  âœ… All db.query() calls removed
  âœ… All Mongoose methods implemented
  âœ… All relationships properly configured
  âœ… All services tested and working
  âœ… All routes working with refactored services
  âœ… All error handling in place
  âœ… Performance acceptable
  âœ… Documentation complete
  âœ… Ready for Phase 4 (Frontend Integration)

================================================================================
NEXT PHASE: PHASE 4
================================================================================

Phase 4 will involve:
  â€¢ Frontend route testing
  â€¢ API contract verification
  â€¢ Real-world user scenarios
  â€¢ Performance optimization
  â€¢ Final bug fixes

Estimated Duration: 20-30 hours

================================================================================
READY FOR PHASE 3
================================================================================

Status: âœ… READY

Prerequisites Completed:
  âœ“ Phase 1: MongoDB Atlas setup complete
  âœ“ Phase 2: All 34 schemas created
  âœ“ To-do list created
  âœ“ Refactoring strategy documented
  âœ“ Patterns documented
  âœ“ Testing strategy ready

Current Status:
  â€¢ 0 services refactored
  â€¢ 46 services remaining
  â€¢ 70 hours of work ahead
  â€¢ High confidence in approach

Waiting for confirmation to begin Task 1: Service Discovery & Analysis.

================================================================================
